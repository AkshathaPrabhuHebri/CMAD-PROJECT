pipeline {

   agent none
   
   stages {
      stage('client-build') {
      	agent{
                docker{
                 image 'node:10.9-alpine'
                 args '-v $HOME/node_modules:/root/node_modules'
                }
		}
		
         steps {
            echo 'compile syslog client service'
            dir('syslog-client'){
            	sh 'npm install'
               sh 'npm run-script build'
               archiveArtifacts artifacts: dist, fingerprint: true
            }

         }
      }
      
      stage('client-test') {
      	agent{
                docker{
                 image 'node:10.9-alpine'
                 args '-v $HOME/node_modules:/root/node_modules'
                }
		}
         steps {
            echo 'run unit tests'
            dir('syslog-client'){
            	sh 'npm install'
		         sh 'npm test'
            }
            
         }
      }
      
	  
     stage('client-copy-artifact') {
        agent any
        steps{
           echo 'copying artifact'
           copyArtifacts filter: 'dist', fingerprintArtifacts: true, projectName: '${JOB_NAME}', selector: specific('${BUILD_NUMBER}'), target: './syslog-client/'
        }
     }
	  
	  stage('client-docker-package'){
	  	agent any
	  	steps{
      		echo 'Packaging syslog-client app with docker'
      		script{
      			docker.withRegistry('https://index.docker.io/v1/', 'dockerlogin') {
      				def syslogClientImage = docker.build("myselfakshatha/syslog-client:v${env.BUILD_ID}", "./syslog-client/")
      				syslogClientImage.push()
      				syslogClientImage.push("latest")
      				}
      			}
      			
      		}
      	}
      			
   }
   
        post{
         always{
             echo 'the cmad-syslog-client job is complete'
         }
   }
}